@page "/"
@using Web.Components.BroodwarComponents
@using Shared
@using Shared.Utils
@inject MyStarcraftBot myStarcraftBot
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>GeminiAscendant - StarCraft AI</PageTitle>

<div class="container">
    <LaunchControl />
    @if(myStarcraftBot.InGame)
    {
        <GameSpeedControl />
    }

    <div class="mt-4">
        <h3>Game History</h3>
        @if (History.Any())
        {
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Map</th>
                        <th>Result</th>
                        <th>Duration</th>
                        <th>Race</th>
                        <th>Build</th>
                        <th>Supply</th>
                        <th>Army</th>
                        <th>Workers</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var game in History)
                    {
                        <tr class="@(game.Result == "Win" ? "table-success" : "table-danger")">
                            <td>@game.Timestamp.ToString("g")</td>
                            <td>@game.MapName</td>
                            <td>@game.Result</td>
                            <td>@game.Duration</td>
                            <td>@game.Race</td>
                            <td>@game.BuildOrder</td>
                            <td>@game.SupplyUsed / @game.SupplyTotal</td>
                            <td>@game.ArmyCount</td>
                            <td>@game.WorkerCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No games recorded yet.</p>
        }
    </div>
</div>

@code {
    private List<GameRecord> History = new();

    protected override void OnInitialized()
    {
        myStarcraftBot.StatusChanged += Reload;
        LoadHistory();
    }

    public void Dispose()
    {
        myStarcraftBot.StatusChanged -= Reload;
    }

    private void Reload()
    {
        LoadHistory();
        InvokeAsync(StateHasChanged);
    }

    private void LoadHistory()
    {
        History = GameStatLogger.GetGameHistory();
    }
}